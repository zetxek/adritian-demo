name: Sync Theme Content

# This workflow syncs content (i18n files, example content) from the theme repository
# when theme updates are made, especially when PRs in the theme repo contain new
# languages, configurations, or demo content.

permissions:
  contents: write
  pull-requests: write

on:
  # Triggered by the theme repository via repository_dispatch
  repository_dispatch:
    types: [sync-theme-content]

  # Can be manually triggered to sync content for an existing PR
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch name in adritian-demo to sync content to (defaults to main)'
        required: false
        default: 'main'
        type: string
      theme_branch:
        description: 'Theme branch to sync from (defaults to main)'
        required: false
        default: 'main'
        type: string

jobs:
  sync-content:
    runs-on: ubuntu-latest

    steps:
      - name: Determine branch and commit
        id: determine_branch
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            # Get from dispatch payload
            BRANCH="${{ github.event.client_payload.branch }}"
            THEME_REF="${{ github.event.client_payload.theme_ref }}"
            THEME_BRANCH="${{ github.event.client_payload.theme_branch }}"
          else
            # Get from workflow inputs
            BRANCH="${{ github.event.inputs.branch }}"
            THEME_REF="${{ github.event.inputs.theme_branch }}"
            THEME_BRANCH="${{ github.event.inputs.theme_branch }}"
          fi

          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "theme_ref=$THEME_REF" >> $GITHUB_OUTPUT
          echo "theme_branch=$THEME_BRANCH" >> $GITHUB_OUTPUT

      - name: Checkout demo repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.determine_branch.outputs.branch }}
          token: ${{ secrets.CI_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true

      - name: Checkout theme repository
        uses: actions/checkout@v4
        with:
          repository: zetxek/adritian-free-hugo-theme
          ref: ${{ steps.determine_branch.outputs.theme_ref }}
          path: theme-checkout
          token: ${{ secrets.CI_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Sync i18n files from theme
        run: |
          # Copy i18n files from theme to demo repo, excluding files that already exist
          # to avoid overwriting customizations, but include new language files

          if [ -d "theme-checkout/i18n" ]; then
            echo "Syncing i18n files from theme..."
            mkdir -p i18n

            shopt -s nullglob  # Prevent literal glob strings
            for file in theme-checkout/i18n/*.yaml theme-checkout/i18n/*.yml; do
              filename=$(basename "$file")
              # Copy new language files or update existing ones
              cp "$file" "i18n/$filename"
              echo "Copied $filename"
            done
            shopt -u nullglob
          else
            echo "No i18n directory found in theme"
          fi

      - name: Sync example content from theme
        run: |
          # Copy example content from theme's exampleSite to demo repo
          # This includes homepage content in different languages

          if [ -d "theme-checkout/exampleSite/content" ]; then
            echo "Syncing example content from theme..."

            # Sync home section content (translated versions)
            if [ -d "theme-checkout/exampleSite/content/home" ]; then
              mkdir -p content/home

              shopt -s nullglob  # Prevent literal glob strings
              for file in theme-checkout/exampleSite/content/home/*; do
                filename=$(basename "$file")
                # Only copy language-specific files (e.g., home.ar.md, home.he.md)
                # Skip the base home.md to preserve demo customizations
                if [[ "$filename" == *.*.md && "$filename" != "home.md" ]]; then
                  cp "$file" "content/home/$filename"
                  echo "Copied $filename"
                fi
              done
              shopt -u nullglob
            fi

            # Sync other translated content if present
            for section in blog education experience projects skills testimonial; do
              if [ -d "theme-checkout/exampleSite/content/$section" ]; then
                mkdir -p "content/$section"
                # Copy language-specific files for each section
                shopt -s nullglob  # Prevent literal glob strings
                for file in theme-checkout/exampleSite/content/$section/*; do
                  filename=$(basename "$file")
                  # Only copy language-specific files (e.g., *.ar.md, *.he.md)
                  if [[ "$filename" == *.*.md ]]; then
                    cp "$file" "content/$section/$filename"
                    echo "Copied $filename to $section"
                  fi
                done
                shopt -u nullglob
              fi
            done
          else
            echo "No exampleSite/content directory found in theme"
          fi

      - name: Sync configuration examples if needed
        run: |
          # Check if there are config examples in the theme that should be documented
          if [ -f "theme-checkout/exampleSite/hugo.toml" ]; then
            echo "Theme has example configuration. Check for language settings..."

            # Extract language configuration from theme's example
            if grep -q "\[languages\." theme-checkout/exampleSite/hugo.toml; then
              echo "Found language configuration in theme example"
              # Create a reference file for documentation purposes
              mkdir -p .github/docs
              # Extract language configuration section (up to 50 lines max)
              # This captures the [languages] section and related config
              grep -A 50 "\[languages\." theme-checkout/exampleSite/hugo.toml > .github/docs/language-config-example.toml || true
              echo "Saved language configuration example to .github/docs/language-config-example.toml"
              echo "Note: If language config is longer than 50 lines, it may be truncated."
            fi
          fi

      - name: Check for changes
        id: check_changes
        run: |
          git config --global user.name 'Git bot'
          git config --global user.email 'bot@noreply.github.com'

          if [[ -n $(git status -s) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git status -s
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No content changes to sync"
          fi

      - name: Commit and push content changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git add i18n/ content/ .github/docs/ || true

          # Create detailed commit message
          git commit -m "Sync content from theme" \
            -m "Synced i18n files and example content from the theme repository." \
            -m "This includes:" \
            -m "- Translation files for new languages" \
            -m "- Example content for different languages" \
            -m "- Configuration examples" \
            -m "" \
            -m "Theme ref: ${{ steps.determine_branch.outputs.theme_ref }}"

          git push origin "${{ steps.determine_branch.outputs.branch }}"

          echo "Content synced and pushed successfully"

      - name: Add comment to PR if applicable
        if: steps.check_changes.outputs.has_changes == 'true' && github.event.client_payload.pr_number
        env:
          GITHUB_TOKEN: ${{ secrets.CI_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.client_payload.pr_number }}"

          gh pr comment "$PR_NUMBER" --body - <<'EOF'
          âœ… **Content synced from theme**

          This PR has been updated with content and i18n files from the theme repository:
          - Translation files (i18n/*.yaml)
          - Example content for new languages
          - Configuration examples (in .github/docs/)

          These changes are in a separate commit to demonstrate the new features added in the theme.
          EOF
