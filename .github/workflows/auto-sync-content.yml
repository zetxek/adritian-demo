name: Auto-sync Theme Content on Module Update

# This workflow automatically syncs content from the theme after module updates
# It runs when go.mod is updated in a PR, detecting theme version changes

permissions:
  contents: write
  pull-requests: write

on:
  pull_request:
    paths:
      - 'go.mod'
      - 'go.sum'
    types: [opened, synchronize]

jobs:
  check-and-sync:
    runs-on: ubuntu-latest
    # Only run on preview PRs from theme updates (those with theme-update/ prefix)
    # or PRs explicitly marked as preview in the title
    if: startsWith(github.head_ref, 'theme-update/') || contains(github.event.pull_request.title, 'preview:')

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.CI_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      - name: Get theme version
        id: theme_version
        run: |
          # Extract theme version from go.mod
          THEME_VERSION=$(grep "github.com/zetxek/adritian-free-hugo-theme" go.mod | awk '{print $2}')
          echo "version=$THEME_VERSION" >> $GITHUB_OUTPUT
          echo "Theme version: $THEME_VERSION"

          # Try to extract commit SHA from pseudo-version
          # Pseudo-version format: v0.0.0-yyyymmddhhmmss-abcdefabcdef
          # where abcdefabcdef is the first 12 chars of the commit SHA
          if [[ $THEME_VERSION =~ -([0-9]+)\.[0-9]+-([0-9a-f]+)$ ]]; then
            COMMIT_SHA="${BASH_REMATCH[2]}"
            echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
            echo "Extracted commit SHA: $COMMIT_SHA"
          else
            echo "Could not extract commit SHA from version"
            echo "commit_sha=" >> $GITHUB_OUTPUT
          fi

      - name: Checkout theme repository
        if: steps.theme_version.outputs.commit_sha != ''
        uses: actions/checkout@v4
        with:
          repository: zetxek/adritian-free-hugo-theme
          ref: ${{ steps.theme_version.outputs.commit_sha }}
          path: theme-checkout
          token: ${{ secrets.CI_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Check if content sync is needed
        if: steps.theme_version.outputs.commit_sha != ''
        id: check_sync
        run: |
          NEEDS_SYNC=false

          # Check if theme has i18n files we don't have
          if [ -d "theme-checkout/i18n" ]; then
            shopt -s nullglob  # Prevent literal glob strings
            for file in theme-checkout/i18n/*.yaml theme-checkout/i18n/*.yml; do
              filename=$(basename "$file")
              if [ ! -f "i18n/$filename" ]; then
                echo "New i18n file found: $filename"
                NEEDS_SYNC=true
              fi
            done
            shopt -u nullglob
          fi

          # Check if theme has example content we don't have
          if [ -d "theme-checkout/exampleSite/content/home" ]; then
            shopt -s nullglob  # Prevent literal glob strings
            for file in theme-checkout/exampleSite/content/home/*.*.md; do
              filename=$(basename "$file")
              if [ ! -f "content/home/$filename" ]; then
                echo "New content file found: $filename"
                NEEDS_SYNC=true
              fi
            done
            shopt -u nullglob
          fi

          echo "needs_sync=$NEEDS_SYNC" >> $GITHUB_OUTPUT

      - name: Sync i18n files
        if: steps.check_sync.outputs.needs_sync == 'true'
        run: |
          if [ -d "theme-checkout/i18n" ]; then
            echo "Syncing i18n files from theme..."
            mkdir -p i18n

            shopt -s nullglob  # Prevent literal glob strings
            for file in theme-checkout/i18n/*.yaml theme-checkout/i18n/*.yml; do
              filename=$(basename "$file")
              cp "$file" "i18n/$filename"
              echo "Copied $filename"
            done
            shopt -u nullglob
          fi

      - name: Sync example content
        if: steps.check_sync.outputs.needs_sync == 'true'
        run: |
          if [ -d "theme-checkout/exampleSite/content" ]; then
            echo "Syncing example content from theme..."

            # Sync home section content (translated versions)
            if [ -d "theme-checkout/exampleSite/content/home" ]; then
              mkdir -p content/home

              shopt -s nullglob  # Prevent literal glob strings
              for file in theme-checkout/exampleSite/content/home/*; do
                filename=$(basename "$file")
                # Only copy language-specific files
                if [[ "$filename" == *.*.md && "$filename" != "home.md" ]]; then
                  cp "$file" "content/home/$filename"
                  echo "Copied $filename"
                fi
              done
              shopt -u nullglob
            fi

            # Sync other translated content
            for section in blog education experience projects skills testimonial; do
              if [ -d "theme-checkout/exampleSite/content/$section" ]; then
                mkdir -p "content/$section"
                shopt -s nullglob  # Prevent literal glob strings
                for file in theme-checkout/exampleSite/content/$section/*.*.md; do
                  filename=$(basename "$file")
                  cp "$file" "content/$section/$filename"
                  echo "Copied $filename to $section"
                done
                shopt -u nullglob
              fi
            done
          fi

      - name: Sync configuration examples
        if: steps.check_sync.outputs.needs_sync == 'true'
        run: |
          if [ -f "theme-checkout/exampleSite/hugo.toml" ]; then
            if grep -q "\[languages\." theme-checkout/exampleSite/hugo.toml; then
              echo "Found language configuration in theme example"
              mkdir -p .github/docs
              # Extract language configuration section (up to 50 lines max)
              # This captures the [languages] section and related config
              grep -A 50 "\[languages\." theme-checkout/exampleSite/hugo.toml > .github/docs/language-config-example.toml || true
              echo "Saved language configuration example"
              echo "Note: If language config is longer than 50 lines, it may be truncated."
            fi
          fi

      - name: Commit content changes
        if: steps.check_sync.outputs.needs_sync == 'true'
        run: |
          git config --global user.name 'Git bot'
          git config --global user.email 'bot@noreply.github.com'

          if [[ -n $(git status -s) ]]; then
            git add i18n/ content/ .github/docs/ || true

            git commit -m "Sync content from theme (auto)" \
              -m "Automatically synced i18n files and example content from theme version ${{ steps.theme_version.outputs.version }}." \
              -m "" \
              -m "This includes:" \
              -m "- Translation files for new languages" \
              -m "- Example content for different languages" \
              -m "- Configuration examples" \
              -m "" \
              -m "Synced from commit: ${{ steps.theme_version.outputs.commit_sha }}"

            git push origin "${{ github.head_ref }}"

            echo "Content synced and pushed successfully"
          fi

      - name: Add comment to PR
        if: steps.check_sync.outputs.needs_sync == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.CI_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body - <<'EOF'
          âœ… **Content automatically synced from theme**

          This PR has been updated with content and i18n files from the theme repository (version `${{ steps.theme_version.outputs.version }}`):
          - Translation files (i18n/*.yaml)
          - Example content for new languages
          - Configuration examples (in .github/docs/)

          These changes are in a separate commit to demonstrate the new features added in the theme.
          EOF
